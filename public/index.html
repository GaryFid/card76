<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.I.D.R. - Punishment Inevitable: Dumb Rules</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    .profile-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 56px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px #1e3c72aa;
      min-width: 180px;
      z-index: 1200;
      padding: 8px 0;
      font-size: 1.08em;
      animation: fadeIn 0.3s;
    }
    .profile-dropdown.active {
      display: block;
    }
    .profile-dropdown-btn {
      width: 100%;
      background: none;
      border: none;
      text-align: left;
      padding: 12px 24px;
      color: #1e3c72;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.15s;
    }
    .profile-dropdown-btn:hover {
      background: #e3eafc;
      color: #2196f3;
    }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-cards" id="header-cards"></div>
                <div class="header-actions">
                    <div class="wallet-block" id="wallet-block">
                        <button class="wallet-btn" id="wallet-btn">
                            <img src="img/ton-icon.svg" alt="TON" class="crypto-icon">
                            <span class="wallet-balance">0.00</span>
                        </button>
                        <div class="wallet-dropdown" id="wallet-dropdown">
                            <div class="wallet-coin">
                                <img src="img/ton-icon.svg" class="coin-icon" alt="Toncoin">
                                <span class="coin-name">Toncoin</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                            <div class="wallet-coin">
                                <img src="img/jetton-icon.svg" class="coin-icon" alt="JetTon">
                                <span class="coin-name">JetTon</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                            <div class="wallet-coin">
                                <img src="img/solana-icon.svg" class="coin-icon" alt="Solana">
                                <span class="coin-name">Solana</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                            <div class="wallet-coin">
                                <img src="img/trump-icon.svg" class="coin-icon" alt="TRUMP">
                                <span class="coin-name">TRUMP</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-block" id="profile-block" style="position:relative;">
                        <img src="img/player-avatar.svg" alt="–ü—Ä–æ—Ñ–∏–ª—å" class="profile-avatar">
                        <span class="profile-name" id="profile-name">–ì–æ—Å—Ç—å</span>
                        <div class="profile-dropdown" id="profileDropdown">
                          <button class="profile-dropdown-btn" id="editProfileBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                          <button class="profile-dropdown-btn" id="logoutBtn">üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                        </div>
                    </div>
                </div>
            </div>
            <h1>P.I.D.R. - Punishment Inevitable: Dumb Rules</h1>
            <p>P.I.D.R. - Punishment Inevitable: Dumb Rules</p>
        </header>
        
        <main>
            <div class="main-card-loader" id="main-card-loader"></div>
            <div class="card-menu">
                <div class="menu-item" id="start-game">
                    <div class="menu-icon">üéÆ</div>
                    <div class="menu-text">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</div>
                </div>
                
                <div class="menu-item" id="play-ai">
                    <div class="menu-icon">ü§ñ</div>
                    <div class="menu-text">–ò–≥—Ä–∞—Ç—å —Å –ò–ò</div>
                </div>
                
                <div class="menu-item" id="rating">
                    <div class="menu-icon">üèÜ</div>
                    <div class="menu-text">–†–µ–π—Ç–∏–Ω–≥</div>
                </div>
                
                <div class="menu-item menu-item-shop" id="shop">
                    <div class="menu-icon">üõí</div>
                    <div class="menu-text">–ú–∞–≥–∞–∑–∏–Ω</div>
                </div>
                
                <div class="menu-item" id="rules">
                    <div class="menu-icon">üìã</div>
                    <div class="menu-text">–ü—Ä–∞–≤–∏–ª–∞</div>
                </div>
                <div class="menu-item" id="profile-page-btn">
                    <div class="menu-icon">üë§</div>
                    <div class="menu-text">–ü—Ä–æ—Ñ–∏–ª—å</div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>¬© 2025 P.I.D.R. - Punishment Inevitable: Dumb Rules</p>
        </footer>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(30,60,114,0.18); z-index:3000; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:18px; padding:32px 24px; max-width:400px; width:95vw; box-shadow:0 8px 32px #1e3c72aa; position:relative;">
        <button id="closeProfileModal" style="position:absolute; right:18px; top:12px; font-size:2em; background:none; border:none; cursor:pointer;">√ó</button>
        <h2 style="margin-bottom:18px;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <img id="modalAvatar" src="img/player-avatar.svg" style="width:80px; height:80px; border-radius:50%; margin-bottom:12px; object-fit:cover;">
        <form id="editProfileForm">
          <input type="text" id="modalNick" style="width:90%; margin-bottom:10px; font-size:1.1em;" placeholder="–ù–∏–∫–Ω–µ–π–º"><br>
          <input type="file" id="modalAvatarInput" accept="image/*" style="margin-bottom:10px;"><br>
          <button type="submit" style="background:#2196f3; color:#fff; border:none; border-radius:8px; padding:10px 18px; font-size:1em; font-weight:700; cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <div id="profileModalMsg" style="margin-top:10px; color:#e53935;"></div>
      </div>
    </div>
    
    <script src="js/main.js"></script>
    <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user || !user.id) {
        window.location.href = '/register.html';
      }
    } catch {
      window.location.href = '/register.html';
    }
    document.getElementById('shop').onclick = () => {
        window.location.href = 'shop.html';
    };
    document.getElementById('start-game').onclick = () => {
        window.location.href = 'game.html';
    };
    document.getElementById('profile-page-btn').onclick = () => {
        window.location.href = 'profile.html';
    };
    function showWelcomeMessage() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        document.body.innerHTML = '';
        // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.height = '100vh';
        container.style.background = 'linear-gradient(135deg, #3390ec 0%, #fff 100%)';
        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞—Ä—Ç
        const img = document.createElement('img');
        img.src = 'img/cards/ace_of_spades.png';
        img.alt = '–ö–∞—Ä—Ç—ã';
        img.style.width = '120px';
        img.style.marginBottom = '24px';
        img.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18)';
        img.style.borderRadius = '12px';
        // –°–æ–æ–±—â–µ–Ω–∏–µ
        const msg = document.createElement('div');
        msg.innerHTML = `<h2 style='color:#222;margin-bottom:10px;'>Welcome to <span style="color:#3390ec">P.I.D.R. - Punishment Inevitable: Dumb Rules</span>!</h2>
        <p style='font-size:18px;color:#444;margin-bottom:18px;'>Ready to play the wildest card game?<br>Gather your friends or challenge the bots!</p>`;
        // –ö–Ω–æ–ø–∫–∞
        const btn = document.createElement('button');
        btn.textContent = '–ò–≥—Ä–∞—Ç—å!';
        btn.className = 'game-btn';
        btn.style.fontSize = '20px';
        btn.style.padding = '14px 38px';
        btn.style.marginTop = '10px';
        btn.style.background = 'linear-gradient(90deg, #3390ec 0%, #1bffff 100%)';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.borderRadius = '10px';
        btn.style.boxShadow = '0 2px 12px rgba(51,144,236,0.13)';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
            window.location.href = 'game.html';
        };
        // –°–æ–±–∏—Ä–∞–µ–º
        container.appendChild(img);
        container.appendChild(msg);
        container.appendChild(btn);
        document.body.appendChild(container);
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (!localStorage.getItem('user')) {
        showWelcomeMessage();
    }
    // --- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è ---
    const profileBlock = document.querySelector('.profile-block');
    const profileDropdown = document.getElementById('profileDropdown');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    let dropdownOpen = false;
    if (profileBlock && profileDropdown) {
      profileBlock.onclick = function(e) {
        e.stopPropagation();
        dropdownOpen = !dropdownOpen;
        profileDropdown.classList.toggle('active', dropdownOpen);
      };
      document.addEventListener('click', function() {
        profileDropdown.classList.remove('active');
        dropdownOpen = false;
      });
    }
    // --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ –∫–Ω–æ–ø–∫–µ –≤ –¥—Ä–æ–ø–¥–∞—É–Ω–µ ---
    if (editProfileBtn) {
      editProfileBtn.onclick = function(e) {
        e.stopPropagation();
        profileDropdown.classList.remove('active');
        dropdownOpen = false;
        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–æ—Ñ–∏–ª—è
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('modalNick').value = user.username || '';
        document.getElementById('modalAvatar').src = user.avatar || 'img/player-avatar.svg';
        document.getElementById('profileModal').style.display = 'flex';
        document.getElementById('profileModalMsg').textContent = '';
      };
    }
    // --- –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ ---
    if (logoutBtn) {
      logoutBtn.onclick = function(e) {
        e.stopPropagation();
        profileDropdown.classList.remove('active');
        dropdownOpen = false;
        localStorage.removeItem('user');
        window.location.href = '/register.html';
      };
    }
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞
    const modalAvatarInput = document.getElementById('modalAvatarInput');
    if (modalAvatarInput) {
      modalAvatarInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            document.getElementById('modalAvatar').src = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      };
    }
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    const editProfileForm = document.getElementById('editProfileForm');
    if (editProfileForm) {
      editProfileForm.onsubmit = async function(e) {
        e.preventDefault();
        const nick = document.getElementById('modalNick').value.trim();
        if (nick.length < 4) {
          document.getElementById('profileModalMsg').textContent = '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 4 —Å–∏–º–≤–æ–ª–æ–≤';
          return;
        }
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        let avatarUrl = user.avatar || '';
        const file = document.getElementById('modalAvatarInput').files[0];
        if (file) {
          // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Ä–µ–∞–ª–∏–∑—É–π /api/user/:id/avatar)
          const formData = new FormData();
          formData.append('avatar', file);
          const res = await fetch(`/api/user/${user.id}/avatar`, {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if (data.success && data.avatarUrl) {
            avatarUrl = data.avatarUrl;
          } else {
            document.getElementById('profileModalMsg').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞';
            return;
          }
        }
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ –∏ –∞–≤–∞—Ç–∞—Ä
        const res = await fetch(`/api/user/${user.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: nick, avatar: avatarUrl })
        });
        const data = await res.json();
        if (data.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º localStorage –∏ UI
          localStorage.setItem('user', JSON.stringify({ ...user, username: nick, avatar: avatarUrl }));
          document.getElementById('profile-name').textContent = nick;
          document.querySelector('.profile-avatar').src = avatarUrl || 'img/player-avatar.svg';
          document.getElementById('profileModal').style.display = 'none';
        } else {
          document.getElementById('profileModalMsg').textContent = data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
        }
      };
    }
    </script>
</body>
</html> 