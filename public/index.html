<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.I.D.R. - Punishment Inevitable: Dumb Rules</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    .profile-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 56px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px #1e3c72aa;
      min-width: 180px;
      z-index: 1200;
      padding: 8px 0;
      font-size: 1.08em;
      animation: fadeIn 0.3s;
    }
    .profile-dropdown.active {
      display: block;
    }
    .profile-dropdown-btn {
      width: 100%;
      background: none;
      border: none;
      text-align: left;
      padding: 12px 24px;
      color: #1e3c72;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.15s;
    }
    .profile-dropdown-btn:hover {
      background: #e3eafc;
      color: #2196f3;
    }
    .profile-modal-bg {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(30,60,114,0.18);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .profile-modal-bg.active {
      display: flex;
      animation: fadeInBg 0.4s;
    }
    @keyframes fadeInBg {
      from { background: rgba(30,60,114,0.01); }
      to { background: rgba(30,60,114,0.18); }
    }
    .profile-modal-box {
      background: #fff;
      border-radius: 18px;
      padding: 40px 32px 32px 32px;
      max-width: 400px;
      width: 95vw;
      box-shadow: 0 12px 48px #1e3c72cc, 0 2px 8px #2196f355;
      position: relative;
      text-align: center;
      animation: modalPopIn 0.45s cubic-bezier(.4,0,.2,1);
      overflow: visible;
    }
    @keyframes modalPopIn {
      from { opacity: 0; transform: scale(0.85) translateY(40px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .profile-modal-cards {
      position: absolute;
      left: -36px; top: 18px;
      z-index: 1;
      pointer-events: none;
      opacity: 0.18;
    }
    .profile-modal-cards img {
      width: 48px; margin: 0 2px; border-radius: 8px; box-shadow: 0 2px 8px #2196f355;
      transform: rotate(-12deg);
    }
    .profile-modal-cards img:nth-child(2) { transform: rotate(8deg); }
    .profile-modal-cards img:nth-child(3) { transform: rotate(-4deg); }
    .profile-modal-cards img:nth-child(4) { transform: rotate(16deg); }
    .profile-modal-cards img:nth-child(5) { transform: rotate(-18deg); }
    .profile-modal-close {
      position: absolute;
      right: 18px;
      top: 12px;
      font-size: 2em;
      background: none;
      border: none;
      cursor: pointer;
      color: #2196f3;
      z-index: 10;
      transition: color 0.2s;
    }
    .profile-modal-close:hover {
      color: #e53935;
    }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-cards" id="header-cards"></div>
                <div class="header-actions">
                    <div class="wallet-block" id="wallet-block">
                        <button class="wallet-btn" id="wallet-btn">
                            <img src="img/ton-icon.svg" alt="TON" class="crypto-icon">
                            <span class="wallet-balance">0.00</span>
                        </button>
                        <div class="wallet-dropdown" id="wallet-dropdown">
                            <div class="wallet-coin">
                                <img src="img/ton-icon.svg" class="coin-icon" alt="Toncoin">
                                <span class="coin-name">Toncoin</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                            <div class="wallet-coin">
                                <img src="img/jetton-icon.svg" class="coin-icon" alt="JetTon">
                                <span class="coin-name">JetTon</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                            <div class="wallet-coin">
                                <img src="img/solana-icon.svg" class="coin-icon" alt="Solana">
                                <span class="coin-name">Solana</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                            <div class="wallet-coin">
                                <img src="img/trump-icon.svg" class="coin-icon" alt="TRUMP">
                                <span class="coin-name">TRUMP</span>
                                <span class="coin-balance">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-block" id="profile-block" style="position:relative;">
                        <img src="img/player-avatar.svg" alt="–ü—Ä–æ—Ñ–∏–ª—å" class="profile-avatar">
                        <span class="profile-name" id="profile-name">–ì–æ—Å—Ç—å</span>
                        <div class="profile-dropdown" id="profileDropdown">
                          <button class="profile-dropdown-btn" id="logoutBtn">üö™ –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                        </div>
                    </div>
                </div>
            </div>
            <h1>P.I.D.R. - Punishment Inevitable: Dumb Rules</h1>
            <p>P.I.D.R. - Punishment Inevitable: Dumb Rules</p>
        </header>
        
        <main>
            <div class="main-card-loader" id="main-card-loader"></div>
            <div class="card-menu">
                <div class="menu-item" id="start-game">
                    <div class="menu-icon">üéÆ</div>
                    <div class="menu-text">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</div>
                </div>
                
                <div class="menu-item" id="play-ai">
                    <div class="menu-icon">ü§ñ</div>
                    <div class="menu-text">–ò–≥—Ä–∞—Ç—å —Å –ò–ò</div>
                </div>
                
                <div class="menu-item" id="rating">
                    <div class="menu-icon">üèÜ</div>
                    <div class="menu-text">–†–µ–π—Ç–∏–Ω–≥</div>
                </div>
                
                <div class="menu-item menu-item-shop" id="shop">
                    <div class="menu-icon">üõí</div>
                    <div class="menu-text">–ú–∞–≥–∞–∑–∏–Ω</div>
                </div>
                
                <div class="menu-item" id="rules">
                    <div class="menu-icon">üìã</div>
                    <div class="menu-text">–ü—Ä–∞–≤–∏–ª–∞</div>
                </div>
                <div class="menu-item" id="profile-page-btn">
                    <div class="menu-icon">üë§</div>
                    <div class="menu-text">–ü—Ä–æ—Ñ–∏–ª—å</div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>¬© 2025 P.I.D.R. - Punishment Inevitable: Dumb Rules</p>
        </footer>
    </div>
    
    <script src="js/main.js"></script>
    <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user || !user.id) {
        window.location.href = '/register.html';
      }
    } catch {
      window.location.href = '/register.html';
    }
    document.getElementById('shop').onclick = () => {
        window.location.href = 'shop.html';
    };
    document.getElementById('start-game').onclick = () => {
        window.location.href = 'game.html';
    };
    document.getElementById('profile-page-btn').onclick = () => {
        window.location.href = 'profile.html';
    };
    function showWelcomeMessage() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        document.body.innerHTML = '';
        // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.height = '100vh';
        container.style.background = 'linear-gradient(135deg, #3390ec 0%, #fff 100%)';
        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞—Ä—Ç
        const img = document.createElement('img');
        img.src = 'img/cards/ace_of_spades.png';
        img.alt = '–ö–∞—Ä—Ç—ã';
        img.style.width = '120px';
        img.style.marginBottom = '24px';
        img.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18)';
        img.style.borderRadius = '12px';
        // –°–æ–æ–±—â–µ–Ω–∏–µ
        const msg = document.createElement('div');
        msg.innerHTML = `<h2 style='color:#222;margin-bottom:10px;'>Welcome to <span style="color:#3390ec">P.I.D.R. - Punishment Inevitable: Dumb Rules</span>!</h2>
        <p style='font-size:18px;color:#444;margin-bottom:18px;'>Ready to play the wildest card game?<br>Gather your friends or challenge the bots!</p>`;
        // –ö–Ω–æ–ø–∫–∞
        const btn = document.createElement('button');
        btn.textContent = '–ò–≥—Ä–∞—Ç—å!';
        btn.className = 'game-btn';
        btn.style.fontSize = '20px';
        btn.style.padding = '14px 38px';
        btn.style.marginTop = '10px';
        btn.style.background = 'linear-gradient(90deg, #3390ec 0%, #1bffff 100%)';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.borderRadius = '10px';
        btn.style.boxShadow = '0 2px 12px rgba(51,144,236,0.13)';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
            window.location.href = 'game.html';
        };
        // –°–æ–±–∏—Ä–∞–µ–º
        container.appendChild(img);
        container.appendChild(msg);
        container.appendChild(btn);
        document.body.appendChild(container);
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (welcome —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç user.id)
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user || !user.id) {
        showWelcomeMessage();
      }
    } catch {
      showWelcomeMessage();
    }
    // --- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è ---
    const profileBlock = document.querySelector('.profile-block');
    const profileDropdown = document.getElementById('profileDropdown');
    const logoutBtn = document.getElementById('logoutBtn');
    let dropdownOpen = false;
    if (profileBlock && profileDropdown) {
      profileBlock.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownOpen = !dropdownOpen;
        profileDropdown.classList.toggle('active', dropdownOpen);
      });
      // –ö–ª–∏–∫ –≤–Ω–µ –º–µ–Ω—é ‚Äî –∑–∞–∫—Ä—ã—Ç—å
      document.addEventListener('click', function(e) {
        if (!profileDropdown.contains(e.target) && !profileBlock.contains(e.target)) {
          profileDropdown.classList.remove('active');
          dropdownOpen = false;
        }
      });
      // –ö–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é ‚Äî –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å
      profileDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
    // --- –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ ---
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        profileDropdown.classList.remove('active');
        dropdownOpen = false;
        localStorage.removeItem('user');
        fetch('/auth/logout', { credentials: 'include' })
          .finally(() => window.location.href = '/register.html');
      });
    }
    </script>

    <!-- –ë—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
    <div class="burger-menu">
        <div class="burger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
    <div class="side-menu">
        <div class="friends-list">
            <div class="friends-header">
                <div class="friends-title">–î—Ä—É–∑—å—è</div>
                <button class="add-friend-btn" id="addFriendBtn">
                    <i class="fas fa-user-plus"></i>
                </button>
            </div>
            <div id="friendsList">
                <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞ -->
    <div class="add-friend-modal" id="addFriendModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</div>
                <button class="close-modal">&times;</button>
            </div>
            <input type="text" class="friend-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É –∏–ª–∏ @username" id="friendSearch">
            <div class="search-results" id="searchResults">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é
    document.querySelector('.burger-icon').addEventListener('click', function() {
        this.classList.toggle('active');
        document.querySelector('.side-menu').classList.toggle('active');
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(e) {
        const sideMenu = document.querySelector('.side-menu');
        const burgerMenu = document.querySelector('.burger-menu');
        if (!sideMenu.contains(e.target) && !burgerMenu.contains(e.target)) {
            sideMenu.classList.remove('active');
            document.querySelector('.burger-icon').classList.remove('active');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞
    const addFriendBtn = document.getElementById('addFriendBtn');
    const addFriendModal = document.getElementById('addFriendModal');
    const closeModal = document.querySelector('.close-modal');
    const friendSearch = document.getElementById('friendSearch');

    addFriendBtn.addEventListener('click', () => {
        addFriendModal.classList.add('active');
    });

    closeModal.addEventListener('click', () => {
        addFriendModal.classList.remove('active');
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    addFriendModal.addEventListener('click', (e) => {
        if (e.target === addFriendModal) {
            addFriendModal.classList.remove('active');
        }
    });

    // –ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π
    let searchTimeout;
    friendSearch.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchUsers(e.target.value);
        }, 300);
    });

    async function searchUsers(query) {
        if (!query) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            const resultsHtml = data.users.length ? 
                data.users.map(user => `
                    <div class="friend-item">
                        <img src="${user.avatar_url || '/images/default-avatar.png'}" class="friend-avatar" alt="${user.username}">
                        <div class="friend-info">
                            <div class="friend-name">${user.display_name || user.username}</div>
                            <div class="friend-status">${user.telegram_username ? '@' + user.telegram_username : ''}</div>
                        </div>
                        <button class="friend-action-btn invite-btn" onclick="addFriend('${user.id}')">
                            –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                `).join('') :
                '<div class="no-results">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';

            document.getElementById('searchResults').innerHTML = resultsHtml;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            document.getElementById('searchResults').innerHTML = 
                '<div class="no-results">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
    async function loadFriends() {
        try {
            const response = await fetch('/api/friends');
            const data = await response.json();

            const friendsHtml = data.friends.length ?
                data.friends.map(friend => `
                    <div class="friend-item">
                        <img src="${friend.avatar_url || '/images/default-avatar.png'}" class="friend-avatar" alt="${friend.username}">
                        <div class="friend-info">
                            <div class="friend-name">${friend.display_name || friend.username}</div>
                            <div class="friend-status ${friend.online ? 'online' : 'offline'}">
                                ${friend.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn invite-btn" onclick="inviteFriend('${friend.id}')">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="friend-action-btn play-btn" onclick="playWithFriend('${friend.id}')">
                                <i class="fas fa-gamepad"></i>
                            </button>
                        </div>
                    </div>
                `).join('') :
                '<div class="no-results">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';

            document.getElementById('friendsList').innerHTML = friendsHtml;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error);
            document.getElementById('friendsList').innerHTML = 
                '<div class="no-results">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥—Ä—É–∑—å—è–º–∏
    async function addFriend(userId) {
        try {
            const response = await fetch('/api/friends/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId })
            });
            const data = await response.json();
            
            if (data.success) {
                addFriendModal.classList.remove('active');
                loadFriends();
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
    }

    async function inviteFriend(userId) {
        try {
            const response = await fetch('/api/friends/invite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId })
            });
            const data = await response.json();
            
            if (data.success) {
                alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
    }

    async function playWithFriend(userId) {
        try {
            const response = await fetch('/api/game/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    type: 'friend',
                    friendId: userId 
                })
            });
            const data = await response.json();
            
            if (data.success) {
                window.location.href = `/game.html?id=${data.gameId}`;
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadFriends);
    </script>
</body>
</html> 